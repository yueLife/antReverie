{% extends "PublicBundle::Layouts/datatableLayout.html.twig" %}

{% block pageLevelPluginsStyle %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset(GLOBAL~'plugins/fancybox/source/jquery.fancybox.css') }}" type="text/css" />
    <link rel="stylesheet" href="{{ asset(GLOBAL~'plugins/jquery-file-upload/blueimp-gallery/blueimp-gallery.min.css') }}" type="text/css" />
    <link rel="stylesheet" href="{{ asset(GLOBAL~'plugins/jquery-file-upload/css/jquery.fileupload.css') }}" type="text/css" />
    <link rel="stylesheet" href="{{ asset(GLOBAL~'plugins/jquery-file-upload/css/jquery.fileupload-ui.css') }}" type="text/css" />

{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="portlet box blue">
                <div class="portlet-title">
                    <div class="caption font-white">
                        <i class="iconfont icon-file font-white"></i>
                        <span class="caption-subject bold uppercase">我的文件</span>
                    </div>
                    <div class="actions">
                        <a href="#file-upload-modal" class="btn btn-default btn-sm" data-toggle="modal">
                            <i class="iconfont icon-upload"></i> 文件上传 </a>
                    </div>
                </div>
                <div class="portlet-body">
                    <table class="table table-striped table-hover order-column my-file-table">
                        <thead>
                            <tr>
                                <th style="width:50px !important;">ID</th>
                                <th style="width:300px !important;">文件名</th>
                                <th style="width:150px !important;">上传时间</th>
                                <th style="width:50px !important;">状态</th>
                                <th style="width:100px !important;">操作</th>
                                <th style="width:500px !important;">功能</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for file in goodsFiles if file.id > 800%}
                            <tr>
                                <td>{{ file.id }}</td>
                                <td>{{ file.oldname }}</td>
                                <td>{{ file.uploadTime }}</td>
                                <td>
                                    {% if file.state == 'read' %}
                                        {% set state = 'success' %}
                                        {% set title = '已读' %}
                                    {% elseif file.state == 'unread' %}
                                        {% set state = 'warning' %}
                                        {% set title = '未读' %}
                                    {% elseif file.state == 'wrong' %}
                                        {% set state = 'danger' %}
                                        {% set title = '错误' %}
                                    {% endif %}
                                    <button type="button" class="btn btn-xs btn-{{ state }}">{{ title }}</button>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-xs default red-stripe">删除</button>
                                    <button type="button" class="btn btn-xs default green-meadow-stripe">下载</button>
                                </td>
                                <td>
                                    {% for type in styleTypes %}
                                        <a href="#{{ type.route }}" class="btn btn-link">{{ type.title }}</a>
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade bs-modal-lg" id="file-upload-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">文件上传</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <form id="fileupload" action="{{ path('upload') }}" method="POST" enctype="multipart/form-data">
                                <div class="row fileupload-buttonbar">
                                    <div class="col-lg-6">
                                        <span class="btn green fileinput-button">
                                            <i class="iconfont icon-plus"></i>
                                            <span> 添加文件 </span>
                                            <input type="file" name="files[]" multiple=""> </span>
                                        <button type="submit" class="btn blue start">
                                            <i class="iconfont icon-upload"></i>
                                            <span> 开始上传 </span>
                                        </button>
                                        <button type="reset" class="btn warning cancel">
                                            <i class="iconfont icon-ban-circle"></i>
                                            <span> 取消上传 </span>
                                        </button>
                                    </div>
                                    <div class="col-lg-6 fileupload-progress fade">
                                        <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                            <div class="progress-bar progress-bar-success" style="width:0%;"> </div>
                                        </div>
                                        <div class="progress-extended"> &nbsp; </div>
                                    </div>
                                </div>
                                <table role="presentation" class="table table-striped clearfix">
                                    <tbody class="files"> </tbody>
                                </table>
                            </form>
                        </div>
                    </div>
                    {% verbatim  %}
                    <script id="template-upload" type="text/x-tmpl">
                        {% for (var i=0, file; file=o.files[i]; i++) { %}
                        <tr class="template-upload fade">
                            <td>
                                <span class="name">{%=file.name%}</span>
                                <strong class="error label label-danger"></strong>
                            </td>
                            <td>
                                <span class="size">Processing...</span>
                                <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                    <div class="progress-bar progress-bar-success" style="width:0%;"></div>
                                </div>
                            </td>
                            <td>
                                {% if (!i && !o.options.autoUpload) { %}
                                <button class="btn blue start" disabled>
                                    <i class="iconfont icon-upload"></i>
                                    <span>开始</span>
                                </button> {% } %} {% if (!i) { %}
                                <button class="btn red cancel">
                                    <i class="iconfont icon-ban-circle"></i>
                                    <span>取消</span>
                                </button>
                                {% } %}
                            </td>
                        </tr>
                        {% } %}
                    </script>
                    <script id="template-download" type="text/x-tmpl">
                        {% for (var i=0, file; file=o.files[i]; i++) { %}
                        <tr class="template-download fade">
                            <td>
                                <span>{%=file.name%}</span>
                                {% if (file.error) { %}
                                <div>
                                    <span class="label label-danger">错误</span> {%=file.error%}
                                </div>
                                {% } %}
                            </td>
                            <td>
                                <span class="size">{%=o.formatFileSize(file.size)%}</span>
                            </td>
                            <td>
                                {% if (file.deleteUrl) { %}
                                <button class="btn red delete btn-sm">
                                    <i class="iconfont icon-trash"></i>
                                    <span>删除</span>
                                </button>
                                {% } else { %}
                                <button class="btn yellow cancel btn-sm">
                                    <i class="iconfont icon-ban-circle"></i>
                                    <span>取消</span>
                                </button>
                                {% } %}
                            </td>
                        </tr>
                        {% } %}
                    </script>
                    {%  endverbatim %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn dark btn-outline" data-dismiss="modal">关闭</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
{% endblock %}

{% block pageLevelPluginsScript %}
    {{ parent() }}
    <script src="{{ asset(GLOBAL~'plugins/fancybox/source/jquery.fancybox.pack.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/vendor/jquery.ui.widget.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/vendor/tmpl.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/vendor/load-image.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/vendor/canvas-to-blob.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/blueimp-gallery/jquery.blueimp-gallery.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/jquery.iframe-transport.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/jquery.fileupload.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/jquery.fileupload-process.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/jquery.fileupload-image.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/jquery.fileupload-audio.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/jquery.fileupload-video.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/jquery.fileupload-validate.js') }}" type="text/javascript"></script>
    <script src="{{ asset(GLOBAL~'plugins/jquery-file-upload/js/jquery.fileupload-ui.js') }}" type="text/javascript"></script>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        $(function(){
            datatable($('.my-file-table'));
            $('#file-upload-modal').modal('show');
            uploadLayout();
            $(document).on('click', '.files .delete', function (event) {
                $(this).closest('tr').remove();
            });
            $('#file-upload-modal').on('hidden.bs.modal', function (e) {
                $('.files .template-download').remove();
            });
            function uploadLayout() {
                $('#fileupload').fileupload({
                    disableImageResize: false,
                    autoUpload: false,
                    disableImageResize: /Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),
                    maxFileSize: 5*1024*1024,
                    acceptFileTypes: /(\.|\/)(csv|xlsx?)$/i,
//                    maxNumberOfFiles: 10,
                    messages: {
                        maxNumberOfFiles: '单次最大上传文件个数为10个',
                        acceptFileTypes: '该文件格式不允许上传',
                        maxFileSize: '单文件不允许超过5MB',
                        minFileSize: '单文件过小',
                        unknownError: '未知错误'
                    }
                });

                // 上传支持CORS的浏览器的服务器状态检查：
                if ($.support.cors) {
                    $.ajax({
                        type: 'HEAD'
                    }).fail(function () {
                        $('<div class="alert alert-danger"/>')
                            .text('上传服务器当前不可用 - ' + new Date()).appendTo('#fileupload');
                    });
                }
            }
        });
    </script>
{% endblock %}
