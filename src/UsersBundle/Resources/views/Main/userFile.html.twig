{% extends "PublicBundle::Layouts/baseLayout.html.twig" %}

{% use 'PublicBundle::Modules/Blocks/upload.html.twig' %}
{% use 'PublicBundle::Modules/Blocks/datatable.html.twig' %}

{% block pagePluginsStyles %}
    {{ block('datatableStyle') }}
    {{ block('uploadStyle') }}
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="portlet box blue">
                <div class="portlet-title">
                    <div class="caption font-white">
                        <i class="iconfont icon-file font-size-20 font-white"></i>
                        <span class="caption-subject bold uppercase">我的文件</span>
                    </div>
                    <div class="actions">
                        <a href="#file-upload-modal" class="btn btn-sm default btn-outline" data-toggle="modal">
                            <i class="iconfont icon-upload"></i> 文件上传 </a>
                    </div>
                </div>
                <div class="portlet-body">
                    <table class="table table-striped table-hover order-column my-files-table">
                        <thead>
                            <tr>
                                <th style="width:50px !important;">ID</th>
                                <th style="width:300px !important;">文件名</th>
                                <th style="width:50px !important;">状态</th>
                                <th style="width:80px !important;">文件类型</th>
                                <th style="width:130px !important;">上传时间</th>
                                <th style="width:80px !important;">操作</th>
                                {% spaceless %}
                                {% if shelfModels|length > 3 %}
                                    {% set width = shelfModels|length * 65 %}
                                {% else %}
                                    {% set width = 200 %}
                                {% endif %}
                                {% endspaceless -%}
                                <th style="width:{{ width }}px !important;">功能</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for file in uploadFiles %}
                            <tr>
                                <td> {{ file.id }} </td>
                                <td data-filename="{{ file.filename }}"> {{ file.oldname }} </td>
                                <td>
                                    {% if file.state == 'read' %}
                                        {% set state = 'success' %}
                                        {% set title = '已读' %}
                                    {% elseif file.state == 'unread' %}
                                        {% set state = 'warning' %}
                                        {% set title = '未读' %}
                                    {% elseif file.state == 'wrong' %}
                                        {% set state = 'danger' %}
                                        {% set title = '错误' %}
                                    {% endif %}
                                    <button type="button" class="btn btn-xs btn-{{ state }}"> {{ title }} </button>
                                </td>
                                <td>
                                    {% if file.extension == 'goodsFile' %}
                                        货架文件
                                    {% elseif file.extension == 'wordsFile' %}
                                        检测文件
                                    {% elseif file.extension == 'unusedWordsFile' %}
                                        禁词文件
                                    {% endif %}
                                </td>
                                <td> {{ file.uploadTime }} </td>
                                <td>
                                    <button type="button" class="btn btn-xs default red-stripe delete-file-btn"> 删除</button>
                                    <button type="button" class="btn btn-xs default green-meadow-stripe"> 下载 </button>
                                </td>
                                <td>
                                    {% if file.extension == 'goodsFile' %}
                                        {% for m in shelfModels %}
                                        <a href="{{ path('displayModel', { 'id': file.id, 'route': m.route }) }}" class="btn btn-link btn-xs font-size-14"> {{ m.title }} </a>
                                        {% endfor %}
                                    {% elseif file.extension == 'wordsFile' %}
                                        <a href="#test" class="btn btn-link btn-xs font-size-14"> 检测文件 </a>
                                    {% elseif file.extension == 'unusedWordsFile' %}
                                        <a href="#read" class="btn btn-link btn-xs font-size-14"> 读取文件 </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% set chooseFile = true %}
    {{ block('uploadModal') }}
{% endblock %}

{% block pagePluginsScripts %}
    {{ block('datatableScript') }}
    {{ block('uploadScript') }}
{% endblock %}

{% block javascripts %}
    {{ block('datatableJavascripts') }}
    {{ block('uploadJavascripts') }}
    <script type="text/javascript">
        $(function(){
            datatable($('.my-files-table'));
            $(document).on('click', '.delete-file-btn', function (event) {
                var td = $(this).closest('tr').children('td');
                var jsonData = {
                    'id': td.eq(0).html(),
                    'filename': td.eq(1).attr('data-filename'),
                };

                $.ajax({
                    url: '{{ path('deleteFile') }}',
                    type: 'post',
                    dataType: 'json',
                    data: jsonData,
                }).done(function (data) {
                    console.log(data);
                }).fail(function (data) {
                    console.log("未知错误！");
                });
            });
            $(document).on('click', '.exchange-table', function (event) {
                $('.goods-table').toggleClass('display').toggleClass('display-hide');
                $('.words-table').toggleClass('display').toggleClass('display-hide');
            });
        });
    </script>
{% endblock %}
